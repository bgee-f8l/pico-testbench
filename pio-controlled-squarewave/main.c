#include "pico/stdlib.h"
#include "hardware/pio.h"
#include "hardware/clocks.h"

// Include the header file generated by your PIO assembly file
#include "controlled-squarewave.pio.h"

int main() {
    stdio_init_all();

    // Choose a PIO instance and a state machine
    PIO pio = pio0;
    uint sm = 0;

    // Load the square wave program into the PIO memory
    uint offset = pio_add_program(pio, &controlled_squarewave_program);

    // Configure the PIO state machine
    pio_sm_config c = controlled_squarewave_program_get_default_config(offset);
    sm_config_set_out_pins(&c, 25, 1);  // Output on GPIO 25
    sm_config_set_sideset_pins(&c, 25); // Optional: set side-set pins, if any

    // Set the clock divider to control the base frequency
    sm_config_set_clkdiv(&c, 1.0f);

    // Initialize the state machine with the configuration
    pio_sm_init(pio, sm, offset, &c);

    // Start the state machine
    pio_sm_set_enabled(pio, sm, true);

    // Send 'x' and 'y' values to the PIO
    uint32_t frequency = 1000; // Frequency of the square wave
    uint32_t num_pulses = 100; // Number of pulses to generate

    // Calculate 'x' based on desired frequency
    uint32_t x = clock_get_hz(clk_sys) / (2 * frequency);
    
    // Write 'x' and 'y' to PIO
    pio_sm_put_blocking(pio, sm, x);
    pio_sm_put_blocking(pio, sm, num_pulses);

    // Keep running until all pulses are generated
    while (num_pulses > 0) {
        tight_loop_contents();
    }

    // Stop the state machine
    pio_sm_set_enabled(pio, sm, false);

    return 0;
}